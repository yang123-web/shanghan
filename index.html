import React, { useState } from 'react';
import { Alert, AlertDescription } from '@/components/ui/alert';

const symptomsData = {
  // 太阳病证
  taiyang: {
    symptoms: ['发热', '头痛', '恶寒', '脉浮', '无汗', '有汗'],
    prescriptions: {
      'noSweat': {
        name: '麻黄汤',
        herbs: ['麻黄', '桂枝', '杏仁', '甘草'],
        description: '发热恶寒，无汗而喘'
      },
      'withSweat': {
        name: '桂枝汤',
        herbs: ['桂枝', '芍药', '生姜', '大枣', '甘草'],
        description: '发热汗出，恶风'
      }
    }
  },
  // 阳明病证
  yangming: {
    symptoms: ['发热', '不恶寒', '口渴', '汗出', '便秘', '腹满'],
    prescriptions: {
      'constipation': {
        name: '大承气汤',
        herbs: ['大黄', '厚朴', '枳实', '芒硝'],
        description: '阳明腑实证'
      }
    }
  },
  // 少阳病证
  shaoyang: {
    symptoms: ['往来寒热', '胸胁苦满', '口苦', '咽干', '目眩', '心烦'],
    prescriptions: {
      'default': {
        name: '小柴胡汤',
        herbs: ['柴胡', '黄芩', '人参', '甘草', '半夏', '生姜', '大枣'],
        description: '和解少阳'
      }
    }
  }
};

const DiagnosisSystem = () => {
  const [selectedSymptoms, setSelectedSymptoms] = useState([]);
  const [diagnosis, setDiagnosis] = useState(null);
  const [warning, setWarning] = useState('');

  const handleSymptomSelect = (symptom) => {
    if (selectedSymptoms.includes(symptom)) {
      setSelectedSymptoms(selectedSymptoms.filter(s => s !== symptom));
    } else {
      setSelectedSymptoms([...selectedSymptoms, symptom]);
    }
  };

  const analyzeSyndromes = () => {
    if (selectedSymptoms.length < 2) {
      setWarning('请至少选择两个症状进行诊断');
      return;
    }
    
    // 症状匹配逻辑
    let maxMatches = 0;
    let bestMatch = null;
    let matchedPrescription = null;

    Object.entries(symptomsData).forEach(([syndrome, data]) => {
      const matches = selectedSymptoms.filter(s => 
        data.symptoms.includes(s)).length;
      
      if (matches > maxMatches) {
        maxMatches = matches;
        bestMatch = syndrome;
        
        // 确定具体方剂
        if (syndrome === 'taiyang') {
          matchedPrescription = selectedSymptoms.includes('无汗') ? 
            data.prescriptions.noSweat : data.prescriptions.withSweat;
        } else {
          matchedPrescription = data.prescriptions.default;
        }
      }
    });

    if (bestMatch && matchedPrescription) {
      setDiagnosis({
        syndrome: bestMatch,
        prescription: matchedPrescription
      });
      setWarning('');
    } else {
      setWarning('无法确定诊断，请重新选择症状');
    }
  };

  return (
    <div className="max-w-2xl mx-auto p-6">
      <h1 className="text-2xl font-bold mb-6">中医诊断系统</h1>
      
      <div className="mb-6">
        <h2 className="text-xl mb-4">请选择症状（可多选）：</h2>
        <div className="flex flex-wrap gap-2">
          {Object.values(symptomsData).flatMap(data => 
            data.symptoms.map(symptom => (
              <button
                key={symptom}
                onClick={() => handleSymptomSelect(symptom)}
                className={`px-4 py-2 rounded-full ${
                  selectedSymptoms.includes(symptom)
                    ? 'bg-blue-500 text-white'
                    : 'bg-gray-200'
                }`}
              >
                {symptom}
              </button>
            ))
          )}
        </div>
      </div>

      <button
        onClick={analyzeSyndromes}
        className="bg-green-500 text-white px-6 py-2 rounded mb-4"
      >
        诊断
      </button>

      {warning && (
        <Alert variant="destructive" className="mb-4">
          <AlertDescription>{warning}</AlertDescription>
        </Alert>
      )}

      {diagnosis && (
        <div className="mt-6 p-4 border rounded">
          <h3 className="text-xl font-bold mb-2">诊断结果：</h3>
          <p className="mb-2">证型：{diagnosis.syndrome}</p>
          <p className="mb-2">推荐方剂：{diagnosis.prescription.name}</p>
          <p className="mb-2">组成：{diagnosis.prescription.herbs.join('、')}</p>
          <p>说明：{diagnosis.prescription.description}</p>
        </div>
      )}
    </div>
  );
};

export default DiagnosisSystem;
